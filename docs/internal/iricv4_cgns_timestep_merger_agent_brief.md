# iRICv4-CGNS-Timestep-Merger

iRICの結果をタイムステップごとに出力したCGNSをCase1に束ねるソルバー

## 目的
iRIC の計算結果を「タイムステップごとに分割出力」した CGNS ファイル群を、**iRIC の `Case1.cgn` と同等に扱える 1 つの CGNS（時系列付き）**へ再構成（束ね）する。

- 分割出力はファイル数が多く管理が大変
- 解析・可視化・共有の観点で **単一の `Case1.cgn` 相当**にまとめたい

## 成果物（ゴール）
- 入力：タイムステップごとに分割された CGNS（例：`step_0001.cgn`, `step_0002.cgn`, ...）
- 出力：単一の CGNS（`Case1.cgn` 相当）
  - iRIC GUI が **通常の計算結果（時系列）として読み込める**
  - 時刻配列（TimeValues 等）と各ステップの FlowSolution の対応が整合している

## 想定ユースケース
- iRIC GUI の「分割出力」機能を使う運用が既に存在
- 分割ファイルを束ねることで、
  - iRIC 上での結果表示・比較が容易
  - ファイル管理（移動/共有/バックアップ）が簡単

## 重要な前提
- CGNS は多くの場合 HDF5 形式
- `Case1.cgn` には、格子・条件・結果（時系列）が格納される
- 時系列表現は CGNS の `BaseIterativeData_t` / `ZoneIterativeData_t` 相当の構造（または iRIC が期待する同等構造）で管理される可能性が高い

## 課題（現状の不確実性）
- `Case1.cgn` の実際のノード構造（iRIC が生成する構造）を完全には把握していない
- 分割側 CGNS が「単一時刻スナップショット」なのか「時系列構造を保ったまま 1 ステップだけ残したもの」なのか未確定
- 移動格子（時刻で格子が変わるケース）の有無で束ね方が変わる

## 要件
### 必須要件
1. 分割 CGNS 群を読み取り、単一 CGNS を生成する
2. 出力 CGNS を iRIC が GUI で読み込めること（Case1 相当の互換性）
3. 時刻情報（TimeValues 等）と結果配列の対応が正しいこと
4. ログ出力（どのファイルを取り込み、何を出力したか、エラー時の原因）

### 望ましい要件
- CLI で実行可能（例：`cgns-assemble --input <dir> --output Case1.cgn`）
- 入力ファイル名の自然順ソート（`0001, 0002, ...`）
- 途中ステップ欠損の検知と報告
- 出力先が既存なら上書き確認（または別名生成）

### 非目標（今はやらない）
- 画像やグラフの生成
- iRIC プロジェクト `.ipro` の再パッケージング（まずは CGNS 単体）
- 分割出力の自動生成（merge に集中）

## 期待する入力データの要点
- 各ステップファイルに以下のいずれかが含まれる想定
  - 格子（GridCoordinates）
  - 結果（FlowSolution）
  - 時刻（TimeValues など）※無い可能性もある

## 出力データに必要な整合性
- ベース格子が固定なら：
  - 1つの GridCoordinates を保持し、各ステップの FlowSolution を時系列として格納
- 格子が時刻で変化するなら：
  - 各ステップ格子を保持し、時刻→格子ポインタの対応も正しく持つ（必要に応じて）

## 実装アプローチ案
### 案A：HDF5/CGNSとして直接統合（Pythonツール）
- `h5py` で CGNS ツリー構造を走査
- 必要ノードをコピーし、時系列ノードを再構築
- 出力を 1 ファイル化

### 案B：iRIClib を用いた「分析ソルバー」として再出力
- iRIC が期待する構造に寄せやすい
- ソルバー枠組みが必要（開発コストは上がる可能性）

> 初期段階は「構造把握→最小統合」優先。互換性が厳しいなら案Bへ寄せる。

## 最初にやるべき調査（エージェントへの指示）
1. `Case1.cgn`（通常出力）を 1 件用意し、ノード構造を列挙する
2. 分割された CGNS を 1 件用意し、同様にノード構造を列挙する
3. 差分を比較し、
   - 時刻情報の持ち方
   - FlowSolution の命名規則
   - ポインタ（FlowSolutionPointers 等）の有無
   - 格子が固定か可変か
   を判定する

### 参考：構造列挙（例：Python）
```python
import h5py

def walk(name, obj):
    kind = "GROUP" if isinstance(obj, h5py.Group) else "DATASET"
    print(f"{kind:7} {name}")

with h5py.File("Case1.cgn", "r") as f:
    f.visititems(walk)
```

## 完了条件（Definition of Done）
- 分割CGNSディレクトリを入力して 1 ファイル出力できる
- 出力ファイルを iRIC で開き、時系列として結果が閲覧できる
- 欠損ステップや不整合があれば明確なエラー/警告が出る

## 命名
- リポジトリ名：`iRICv4-CGNS-Timestep-Merger`
- ソルバー名：`v4_CgnTM`

---

### メモ
- まずは「最小の互換ファイル」を作るのが最優先。
- 互換性が厳しい場合、iRIC が期待するノード構成に合わせる必要があるため、`Case1.cgn` の実物を基準に設計する。

