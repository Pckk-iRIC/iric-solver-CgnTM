# iRICv4-CGNS-Timestep-Merger 要件定義書

- リポジトリ名：`iRICv4-CGNS-Timestep-Merger`
- ソルバー名（iRIC表示名）：`CgnTM v4`
- 目的：iRICの結果を「タイムステップごとに分割出力」したCGNS群を、iRICの`Case1.cgn`相当の**時系列CGNS**として束ねる。

---

## 1. 背景・課題
- iRIC GUIの分割出力はファイル数が増えやすく、管理・共有・再利用が難しい。
- 利用者の期待は「通常の`Case1.cgn`と同様に、iRICで時系列として閲覧できる単一ファイル」。

---

## 2. 目的（What / Why）
### 2.1 目的
- 分割されたCGNS（各タイムステップ）を統合し、単一の時系列CGNS（`Case1.cgn`相当）を生成する。

### 2.2 ゴール
- 入力が`.ipro`またはプロジェクトフォルダの場合は、出力も同じ形式のプロジェクトとし、iRICで時系列結果として可視化できる。
  - 出力ディレクトリ配下に**出力用プロジェクトフォルダ**を必ず作成し、その中に統合結果を配置する。
  - 入力が`.ipro`の場合は、出力用プロジェクトフォルダをzip化して`.ipro`として出力する。
- 入力がresultフォルダ直接指定の場合は、出力先に単一のCGNSファイルを作成する（既定は`Case1.cgn`）。
- 欠損・不整合・失敗理由をログで明確に追跡できる。

---

## 3. スコープ
### 3.1 対象（In Scope）
- iRICプロジェクト（`.ipro`または展開済みプロジェクトフォルダ）を入力として受け取り、`result`配下の分割CGNSを統合する。
- resultフォルダを直接入力として受け取るモードを提供する。
- iRICソルバーとして実行できる。
- 親プロセス（iRIC側）と子プロセス（CGNS処理側）を分けて実装する。
 - 入力が`.ipro`の場合は再パッケージングし、出力先へ`.ipro`として書き出す。

### 3.2 対象外（Out of Scope）
- `project.xml`の更新やプロジェクト設定の書き換え。
- 分割出力（split側）の自動生成。
- 画像・グラフ等の生成。
- iRICの複数ケース横断統合（Case1/Case2など複数ケース統合）。

---

## 4. 利用者・運用想定
- 利用者：iRICを業務で使う解析担当者。
- 運用：
  - 分割CGNSはプロジェクト内（または指定フォルダ）に保存済み。
  - 本ソルバーを実行して単一の統合CGNSを生成し、iRICで閲覧する。

---

## 5. 前提・制約
### 5.1 実行環境
- iRICソルバー実行時のPython環境（親）：`iriclib`が利用可能。
- CGNS処理用Python環境（子）：`h5py`等が利用可能。
- **同一プロセス内で仮想環境を切り替えない**（親→子をサブプロセス起動）。

### 5.2 データ前提
- 入力パスは`.ipro`、展開済みプロジェクトフォルダ、または分割CGNS格納フォルダ（resultフォルダ）を想定する。
  - プロジェクトフォルダは`project.xml`の存在で判定する。
  - `.ipro`はzipとして読み取り、内部のプロジェクトフォルダ構造を参照する。
- 分割CGNSの格納先は、プロジェクト入力の場合はプロジェクト直下の`result`配下、resultフォルダ直接入力の場合は指定フォルダ直下を既定とする。
  - ファイル名は`Solution*.cgn`を既定とする（iRIC標準）。
- 分割CGNSが0件の場合は入力不備としてエラー。
- 入力CGNSはHDF5形式であることを想定。
- 初期リリースは**固定格子前提**（可変格子は検知してエラー）。
- 出力先は**ディレクトリ指定**で受け取る。
  - 入力が`.ipro`またはプロジェクトフォルダの場合は、出力用プロジェクトフォルダを`<output_dir>\<入力名>\`に作成する。
  - 入力が`.ipro`の場合：上記フォルダをzip化し、`<output_dir>\<入力名>.ipro`として出力する。
  - `.ipro`出力完了後、出力用プロジェクトフォルダは削除する（中間生成物として扱う）。
  - 入力がフォルダの場合：上記フォルダをそのまま出力する。
  - 入力がresultフォルダ直接指定の場合：`<output_dir>\<出力CGNS名>` を作成する。
- 出力先に同名のプロジェクトフォルダ/iproが存在する場合はエラーとし、ユーザー対応（削除または出力先変更）を促す。

---

## 6. システム構成（実行モデル）
### 6.1 親プロセス（iRICソルバー側）
- 計算条件を`iriclib`で読み取る。
- 読み取る項目は原則として**入出力パスと最小オプションのみ**。
- 子プロセスを起動し、引数としてパス等を渡す。
- 子プロセスの終了コードと標準出力/標準エラーを収集し、iRICログに要約を残す。

### 6.2 子プロセス（CGNS束ねワーカー）
- 入力フォルダを走査し、対象CGNSを列挙・検査・読み込み。
- 統合CGNSを生成し、指定パスへ書き出す。
- 検査結果・サマリをログ出力する。

---

## 7. 機能要件

### 7.1 入力要件（iRIC計算条件）
最低限、以下を受け取る。

- `input_type`（必須）
  - `0`: iproを指定 / `1`: プロジェクトフォルダを指定 / `2`: resultフォルダを指定
- `calc_ipro`（input_type=0 のとき必須）
  - `.ipro`ファイル（相対/絶対）
- `calc_folder`（input_type=1 のとき必須）
  - 展開済みプロジェクトフォルダ（相対/絶対）
- `result_dir_input`（input_type=2 のとき必須）
  - 分割CGNSを格納したresultフォルダ（相対/絶対）
- `output_dir`（必須）
  - 出力先ディレクトリ（相対/絶対）
  - 出力プロジェクトフォルダ名は入力と同名とする
  - 入力が`.ipro`の場合は、同名の`.ipro`を出力する
- `output_name_mode`（任意）
  - `0`: `Case1.cgn`に上書き/作成（既定） / `1`: 別名で出力
- `output_cgns_name`（output_name_mode=1 のとき有効）
  - 既定 `Merged_Solution.cgn`
- `result_subdir`（任意）
  - 分割CGNS格納サブフォルダ（デフォルト `result`、プロジェクト入力時のみ）
- `pattern`（任意）
  - 対象ファイルパターン（例：`Solution*.cgn`、デフォルト `Solution*.cgn`）
- `time_source`（任意）
  - `from_filename`（デフォルト） / `from_cgns`
- `missing_policy`（任意）
  - `error`（デフォルト） / `skip`

> 入力は`.ipro`、プロジェクトフォルダ、またはresultフォルダを前提とする。

### 7.2 入力要件（子プロセス引数）
親プロセスは、子プロセスに**絶対パス**で引数を渡す。
`--project` または `--result-dir-input` のどちらか一方を必須とする。

- `--project`：`.ipro`または展開済みプロジェクトフォルダ
- `--result-dir-input`：resultフォルダを直接指定
- `--output-dir`（必須）：出力先ディレクトリ
- `--result-dir`（任意）：デフォルト `result`（プロジェクト入力時のみ）
- `--pattern`（任意）：デフォルト `Solution*.cgn`
- `--output-cgns-name`（任意）：デフォルト `Case1.cgn`
- `--time-source`（任意）：デフォルト `from_filename`
- `--missing-policy`（任意）：デフォルト `error`
- `--dry-run`（任意）：検査のみ（出力しない）

### 7.3 処理要件（統合ロジック）
- 入力パスから入力種別を決定する。
  - `.ipro`：zip内のルート（`project.xml`が存在する階層）をプロジェクトルートとする。
  - フォルダ：`project.xml`が存在するフォルダをプロジェクトルートとする。
  - resultフォルダ：指定フォルダ直下を分割CGNSの格納先として扱う。
- 分割CGNSは`<project_root>\<result_subdir>`またはresultフォルダ直下から列挙する。
- 対象ファイルを列挙し、**自然順（数値考慮）**でソートする。
- 代表ファイル（通常は最初の1つ）を基準に以下を確定し、全ファイルで整合性検証する。
  - Base/Zoneの数
  - 格子サイズ（isize/jsize等）
  - 取得する結果フィールドの集合（FlowSolution配下の変数）
- 時刻（TimeValues等）の決定：
  - `from_filename`：ファイル名から連番を抽出（末尾連続数字優先）。抽出不可ならエラー。
  - `from_cgns`：入力CGNS内の時刻情報を参照。取得不可ならエラー（`missing_policy`に関わらずエラー）。
- 統合CGNSは、iRICが時系列として認識可能な構造を持つこと。
  - 初期段階は「実在の`Case1.cgn`の構造」に寄せる。
- 統合CGNSは`<output_project_root>\<output_cgns_name>`として生成し、出力用プロジェクトに配置する。
  - `output_cgns_name`の既定は`Case1.cgn`。
  - 別名出力時は既存の`Case1.cgn`には触れない。
- resultフォルダ直接入力時は`<output_dir>\<output_cgns_name>`に出力する。
- 統合後、出力用プロジェクト内の分割CGNSフォルダ（`result_subdir`）は削除する（プロジェクト入力時のみ）。
- 可変格子検知：
  - 格子不一致（サイズ/座標系/ポイント数等）を検知した場合、初期段階はエラーとして停止し、該当ファイルを報告する。

### 7.4 出力要件
- 入力が`.ipro`またはプロジェクトフォルダの場合は、出力は同じ形式のプロジェクト（`.ipro`またはフォルダ）。
- 入力がresultフォルダ直接指定の場合は、出力は単一のCGNSファイル。
- 出力先ディレクトリに**入力と同名**のプロジェクトフォルダを作成する（プロジェクト入力時）。
- 入力が`.ipro`の場合は、そのフォルダをzip化して`.ipro`として出力する。
- 出力CGNS名は`output_cgns_name`（既定`Case1.cgn`）とする。
- 出力先に同名のプロジェクトフォルダ/iproが存在する場合はエラーとする（上書きは許可しない）。

---

## 8. 非機能要件
### 8.1 ログ
- 親プロセス：
  - 起動した子プロセスのコマンドライン（秘密情報なし）
  - 子プロセス終了コード
  - 重要サマリ（ステップ数、出力先、警告件数）
- 子プロセス：
  - 入力ファイル一覧（件数＋代表）
  - スキップ/欠損/不整合の詳細
  - 出力ファイル情報
  - 変数一覧・時刻範囲などのサマリ

### 8.2 エラーハンドリング
- 失敗時に「何が原因で」「どのファイルで」起きたかが分かるメッセージを必ず出す。

### 8.3 性能
- 最初は正しさ優先。
- ファイル数が多い場合でも、列挙・検査・統合の進捗がログに出ること。

### 8.4 再現性
- 入力フォルダ・pattern・ソート結果・time_sourceをログに残す。

---

## 9. 終了コード仕様（子プロセス）
- `0`：成功
- `2`：入力不備（パス不存在、対象ファイル0件など）
- `3`：データ不整合（格子不一致、必須ノード欠落など）
- `4`：書き込み失敗（権限、ディスク不足、出力先ロックなど）
- `10+`：想定外例外

---

## 10. 受け入れ条件（Acceptance Criteria）
- `.ipro`またはプロジェクトフォルダを指定し、分割CGNSが統合されたプロジェクトが出力される。
- resultフォルダを指定し、統合された単一のCGNSファイルが出力される。
- 出力プロジェクト（または`.ipro`）をiRICで開き、時系列として結果が閲覧できる。
- 欠損ステップ・不整合がある場合、エラーまたはスキップ（ポリシーに従う）となり、ログで特定できる。

---

## 11. サンプルデータ
- `data\normal_results`
  - CGNSを分割せずに出力したプロジェクトフォルダ（`Case1.cgn`が存在）。
  - 出力構造の参照用。
- `data\sprit_results.ipro`
  - 分割出力を含む`.ipro`（zip）サンプル。
  - 拡張子を`.zip`に変更して解凍すると、プロジェクトフォルダと同等になる。
  - 分割CGNSは`result\Solution*.cgn`として格納されている。

---

## 12. 将来拡張（Future Work）
- 可変格子（移動格子）の時系列対応（格子ポインタ/格子時系列）。
- 入力が複数Zone/複数Baseの一般化。
- 取り込み変数のフィルタ（必要変数のみ統合）。
- CLI単体配布（iRIC外実行）。
